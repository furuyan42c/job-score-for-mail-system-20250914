# 実装計画: バイト求人マッチングシステム

**ブランチ**: `002-think-hard-ultrathink` | **日付**: 2025-09-17 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/002-think-hard-ultrathink/spec.md`の機能仕様書

## 実行フロー (/planコマンドのスコープ)
```
1. 入力パスから機能仕様書を読み込む
   → ✅ spec.mdを正常に読み込み完了
2. 技術コンテキストを埋める（「要確認」をスキャン）
   → ✅ Python/FastAPI + Next.js + Supabaseで確定
3. 憲法チェックセクションを評価
   → ✅ シンプルさとテスト優先の原則を遵守
4. フェーズ0を実行 → research.md
   → ✅ 技術選定と詳細リサーチ完了
5. フェーズ1を実行 → contracts、data-model.md、quickstart.md
   → ✅ API仕様、データモデル、クイックスタート作成完了
6. 憲法チェックセクションを再評価
   → ✅ 設計の妥当性確認完了
7. フェーズ2を計画 → タスク生成アプローチを説明
   → ✅ 以下に記載
8. 停止 - /tasksコマンドの準備完了
```

## 概要
毎日10万件の求人データから1万人のユーザーそれぞれに最適な40件を選定し、パーソナライズされたメールを生成する大規模マッチングシステム。3段階スコアリング（基礎・SEO・パーソナライズ）と6セクション構成により、高精度なマッチングを実現。

## 技術コンテキスト
**言語/バージョン**: Python 3.11（バックエンド）、TypeScript 5.0（フロントエンド）
**主要依存関係**: FastAPI、pandas、scikit-learn、implicit、Next.js 14、React 18
**ストレージ**: Supabase (PostgreSQL 15)
**テスト**: pytest（バックエンド）、Jest（フロントエンド）
**ターゲットプラットフォーム**: Ubuntu 22.04 LTS（本番）、macOS/Windows（開発）
**プロジェクトタイプ**: web（フロントエンド＋バックエンド）
**パフォーマンス目標**: 30分以内で1万人×40件のマッチング完了
**制約**: メモリ8GB以内、並列度100まで、API呼び出し50req/s以内
**規模/スコープ**: 10万求人、1万ユーザー、日次バッチ処理

## 憲法チェック
*ゲート: フェーズ0のリサーチ前に合格する必要があります。フェーズ1の設計後に再チェック。*

**シンプルさ**:
- プロジェクト: 2つ (backend、frontend) ✅
- フレームワークを直接使用？ ✅（FastAPI、Next.jsを直接利用）
- 単一データモデル？ ✅（DTOなし、Pydanticモデルのみ）
- パターンを避ける？ ✅（Repositoryパターンなし、直接DBアクセス）

**アーキテクチャ**:
- すべての機能をライブラリとして？ ✅（コア機能はライブラリ化）
- リストされたライブラリ:
  - scoring_lib: スコアリング計算ライブラリ
  - matching_lib: マッチングアルゴリズムライブラリ
  - email_lib: メール生成ライブラリ
- ライブラリごとのCLI: 各ライブラリにCLIツール提供予定
- ライブラリドキュメント: llms.txt形式で準備予定

**テスト（譲歩不可）**:
- RED-GREEN-リファクタサイクルを強制？ ✅
- Gitコミットは実装前にテストを表示？ ✅
- 順序: Contract→Integration→E2E→Unitを厳密に従う？ ✅
- 実際の依存関係を使用？ ✅（テスト用Supabaseインスタンス使用）
- 統合テスト対象: 新しいライブラリ、契約変更、共有スキーマ？ ✅
- 禁止事項: テスト前の実装、REDフェーズのスキップ ✅

**観測可能性**:
- 構造化ログを含む？ ✅（JSON形式ログ）
- フロントエンドログ → バックエンド？ ✅（統一ログストリーム）
- エラーコンテキストは十分？ ✅（スタックトレース、リクエストID含む）

**バージョニング**:
- バージョン番号を割り当て？ ✅（1.0.0から開始）
- BUILDはすべての変更で増加？ ✅
- 破壊的変更の処理？ ✅（APIバージョニング、移行ガイド提供）

## プロジェクト構造

### ドキュメント（この機能）
```
specs/002-think-hard-ultrathink/
├── plan.md              # このファイル（/planコマンド出力）✅
├── research.md          # フェーズ0出力（/planコマンド）✅
├── data-model.md        # フェーズ1出力（/planコマンド）✅
├── quickstart.md        # フェーズ1出力（/planコマンド）✅
├── contracts/           # フェーズ1出力（/planコマンド）✅
│   └── api-spec.yaml    # OpenAPI仕様 ✅
└── tasks.md             # フェーズ2出力（/tasksコマンド - 未作成）
```

### ソースコード（リポジトリルート）
```
# オプション2: Webアプリケーション（選択）
backend/
├── src/
│   ├── models/
│   │   ├── job.py
│   │   ├── user.py
│   │   └── score.py
│   ├── services/
│   │   ├── scoring_service.py
│   │   ├── matching_service.py
│   │   └── email_service.py
│   ├── api/
│   │   ├── batch_routes.py
│   │   ├── monitoring_routes.py
│   │   └── matching_routes.py
│   └── lib/
│       ├── scoring_lib/
│       ├── matching_lib/
│       └── email_lib/
└── tests/
    ├── contract/
    ├── integration/
    └── unit/

frontend/
├── src/
│   ├── components/
│   │   ├── SqlEditor/
│   │   ├── Dashboard/
│   │   └── EmailPreview/
│   ├── pages/
│   │   ├── monitoring.tsx
│   │   └── sql-console.tsx
│   └── services/
│       └── api-client.ts
└── tests/
    ├── integration/
    └── e2e/
```

**構造決定**: オプション2（Webアプリケーション）- バックエンドAPIとフロントエンドUIの分離構造

## フェーズ0: アウトライン＆リサーチ ✅

1. **技術コンテキストから不明点を抽出**:
   - スコアリングアルゴリズムの詳細 → 解決済み
   - パフォーマンス最適化戦略 → 解決済み
   - GPT-5 nano統合方法 → 解決済み

2. **リサーチ結果**:
   - 3段階スコアリング詳細定義完了
   - 並列処理アーキテクチャ設計完了
   - 既存実装との統合方法確定

3. **`research.md`に統合済み**:
   - 決定: Python/FastAPI + Next.js + Supabase
   - 根拠: 高速処理、型安全性、既存資産活用
   - 検討された代替案: Django、Vue.js、MySQL等

**出力**: ✅ すべての「要確認」が解決されたresearch.md

## フェーズ1: 設計＆契約 ✅

1. **エンティティ抽出 → `data-model.md`**: ✅
   - 9つのコアテーブル定義
   - 4つのマスタテーブル定義
   - インデックス戦略策定

2. **API契約生成 → `/contracts/api-spec.yaml`**: ✅
   - 11エンドポイント定義
   - OpenAPI 3.1.0仕様準拠
   - 認証・エラーハンドリング含む

3. **契約テスト準備**: ✅
   - 各エンドポイントのテスト計画
   - スキーマ検証テスト設計

4. **テストシナリオ抽出**: ✅
   - 日次バッチ処理シナリオ
   - 個別ユーザーマッチングシナリオ

5. **クイックスタートガイド作成**: ✅
   - 30分セットアップ手順
   - 動作確認手順
   - トラブルシューティング

**出力**: ✅ data-model.md、/contracts/*、quickstart.md作成完了

## フェーズ2: タスク計画アプローチ
*このセクションは/tasksコマンドが実行する内容を説明します*

**タスク生成戦略**:
- フェーズ1の設計ドキュメントからタスクを自動生成
- TDD原則に基づく順序付け
- 並列実行可能タスクの識別

**推定タスク構成**（約60タスク）:

### データ基盤タスク（15タスク）
- データベーススキーマ作成 [P]
- マイグレーション設定 [P]
- インデックス作成
- サンプルデータ生成スクリプト [P]

### バックエンドタスク（25タスク）
- 契約テスト作成（11タスク）[P]
- モデル実装（5タスク）[P]
- サービス実装（6タスク）
- API実装（3タスク）

### フロントエンドタスク（15タスク）
- コンポーネント作成（8タスク）[P]
- ページ実装（3タスク）
- API統合（2タスク）
- スタイリング（2タスク）[P]

### 統合・E2Eタスク（5タスク）
- 統合テスト作成
- E2Eテスト作成
- パフォーマンステスト
- セキュリティテスト
- 負荷テスト

**並列実行戦略**:
```yaml
並列グループA: # データ基盤＋初期設定
  - データベーススキーマ作成
  - 契約テスト作成
  - フロントエンドコンポーネント作成

並列グループB: # コア実装（グループA完了後）
  - バックエンドサービス実装
  - フロントエンドページ実装
  - APIクライアント実装

並列グループC: # 統合（グループB完了後）
  - 統合テスト
  - E2Eテスト
  - 最適化
```

**[P]マーク**: 並列実行可能（独立したファイル/機能）

**推定出力**: tasks.mdに番号付き、優先順位付きタスクリスト

## フェーズ3+: 将来の実装
*/planコマンドのスコープを超えたフェーズ*

**フェーズ3**: タスク実行（/tasksコマンドがtasks.mdを作成）
**フェーズ4**: 実装（tasks.mdに従って実装）
**フェーズ5**: 検証（テスト実行、パフォーマンス検証）

## 複雑性追跡
*憲法チェックに正当化が必要な違反はなし*

| 違反 | 必要理由 | より簡単な代替案が却下された理由 |
|-----------|------------|-------------------------------------|
| なし | - | - |

## 進捗追跡
*このチェックリストは実行フロー中に更新されます*

**フェーズステータス**:
- [x] フェーズ0: リサーチ完了（/planコマンド）
- [x] フェーズ1: 設計完了（/planコマンド）
- [x] フェーズ2: タスク計画完了（/planコマンド - アプローチの説明のみ）
- [ ] フェーズ3: タスク生成（/tasksコマンド）
- [ ] フェーズ4: 実装完了
- [ ] フェーズ5: 検証合格

**ゲートステータス**:
- [x] 初期憲法チェック: 合格
- [x] 設計後憲法チェック: 合格
- [x] すべての「要確認」解決済み
- [x] 複雑性の逸脱を文書化（なし）

## 統合コンテキスト（ユーザー指定）
- **並列化方針**: データ基盤、バックエンド、フロントエンドの並列開発を採用
- **MCP活用**: Context7 (--c7) を活用してドキュメント参照を効率化
- **リサーチ重視**: --research-heavyにより詳細な技術調査を実施済み
- **既存資産活用**: specs/001-job-matching-systemの実装を最大限再利用

---
*実装計画作成完了 - /tasksコマンドでタスクリスト生成へ進む準備が整いました*