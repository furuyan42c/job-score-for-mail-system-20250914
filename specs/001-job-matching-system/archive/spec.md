# 機能仕様書: バイト求人マッチングシステム

**機能ブランチ**: `001-job-matching-system`  
**作成日**: 2025-09-15  
**ステータス**: ドラフト  
**入力**: ユーザーの説明: "Job matching system with email content generation and SQL monitoring interface"

## 実行フロー（メイン）
```
1. Supabaseデータベース構築
   → ER図に基づく全テーブル作成
   → マスターデータのインポート
2. 求人データ処理パイプライン
   → CSVから10万件の求人データを日次インポート
   → スコアリング計算（基礎スコア、SEOスコア、パーソナライズスコア）
   → カテゴリ自動分類（14ニーズカテゴリ、12職種カテゴリ）
3. ユーザーマッチング処理
   → 応募履歴からユーザープロファイル生成
   → 1万人×10万求人のマッチング計算
   → 各ユーザーに最適な40件を選定
4. メール内容生成
   → 選定された求人から魅力的なタイトル生成
   → 6つのセクション（編集部おすすめ、TOP5、地域別、近隣、高収入・日払い、新着）に整理
   → HTMLメールコンテンツとして構造化
5. SQLモニタリングインターフェース
   → Next.jsフロントエンドでSQLクエリ実行画面
   → システム稼働状況の可視化
   → データ整合性チェック機能
6. バッチ処理スケジュール
   → 日次処理フローの自動実行
   → エラー監視とアラート
7. 戻り値: 成功（毎日1万人に配信準備完了）
```

---

## ⚡ クイックガイドライン
- ✅ 10万求人×1万ユーザー＝40万件/日の配信準備を自動化
- ✅ ユーザーの応募履歴に基づく高精度マッチング
- ✅ メール内容生成まで（実際の送信は含まない）
- ❌ メール配信システムの実装（SendGrid/SES連携）は対象外
- 👥 求職者により良い求人情報を届けることが目的

### セクション要件
- **必須セクション**: すべての機能で完成させる必要があります
- **オプションセクション**: 機能に関連する場合のみ含める
- セクションが適用されない場合は、完全に削除します（「N/A」として残さない）

---

## ユーザーシナリオ＆テスト *(必須)*

### 主要ユーザーストーリー
毎朝6時、システムは自動的に10万件の求人データから各ユーザー（1万人）に最適な40件を選定し、パーソナライズされたメール内容を生成する。ユーザーの過去の応募履歴、居住地、希望条件に基づいて、最も関連性の高い求人情報が選ばれ、魅力的なキャッチコピーと共に整理される。

### 受け入れシナリオ
1. **前提** 新規求人データCSVが配置されている、**操作** 日次バッチ処理を実行、**結果** 全求人がスコアリングされ、データベースに格納される
2. **前提** ユーザーが過去に5件応募している、**操作** マッチング処理実行、**結果** 応募傾向に合った40件が選定される
3. **前提** 40件の求人が選定済み、**操作** メール生成処理、**結果** 6セクションに整理されたHTMLコンテンツが生成される
4. **前提** システム管理者がログイン、**操作** SQLモニタリング画面でクエリ実行、**結果** リアルタイムでデータ確認可能

### エッジケース
- 求人データが10万件を超えた場合の処理性能は？
- ユーザーの応募履歴が0件の新規ユーザーへのマッチングは？
- 選定可能な求人が40件未満の場合の処理は？
- CSVデータに不正な形式が含まれている場合のエラーハンドリングは？

## 要件 *(必須)*

### 機能要件
- **FR-001**: システムはSupabaseに20以上のテーブルを作成し、ER図通りの関係性を構築しなければならない
- **FR-002**: システムは日次でCSVから10万件の求人データをインポートし、データクレンジングしなければならない　※今回はテスト開発のため、/Users/naoki/000_PROJECT/job-score-for-mail-system-20250914/data/sample_job_data.csvのデータを入れるのみとする。日次の変更部分などはコメントアウトする。
- **FR-003**: システムは各求人に対して3種類のスコア（基礎、SEO、パーソナライズ）を計算しなければならない
- **FR-004**: システムは求人を14のニーズカテゴリと12の職種カテゴリに自動分類しなければならない
- **FR-005**: システムはユーザーの応募履歴を分析し、プロファイルを生成しなければならない
- **FR-006**: システムは各ユーザーに最適な40件の求人を選定しなければならない
- **FR-007**: システムは選定された求人から魅力的なメールコンテンツを生成しなければならない
- **FR-008**: システムはNext.jsでSQLクエリ実行インターフェースを提供しなければならない
- **FR-009**: システムは日次バッチ処理を指定時刻に自動実行しなければならない
- **FR-010**: システムは処理状況とエラーをログに記録しなければならない

### 非機能要件
- **NFR-001**: 10万求人×1万ユーザーのマッチングを30分以内に完了しなければならない
- **NFR-002**: メモリ使用量は4GB以内に収めなければならない
- **NFR-003**: SQLモニタリング画面のレスポンスは1秒以内でなければならない
- **NFR-004**: バッチ処理の失敗時は自動リトライ（3回まで）しなければならない
- **NFR-005**: 全処理にログを出力し、エラー追跡可能にしなければならない

### 主要エンティティ *(機能がデータを含む場合は含める)*
- **jobs**: 求人情報（job_id、企業名、職種、給与、勤務地、特徴など100以上のフィールド）
- **users**: ユーザー情報（user_id、メールアドレス、居住地、年齢層など）
- **user_actions**: ユーザー行動履歴（応募、クリック、メール開封など）
- **user_profiles**: ユーザープロファイル（応募傾向の集計データ）
- **job_enrichment**: 求人の拡張情報（スコア、カテゴリ、キーワードマッチなど）
- **user_job_mapping**: ユーザーと求人のマッチング結果（日次40万件）
- **daily_job_picks**: 日次選定求人（配信用に整形されたデータ）
- **daily_email_queue**: メール配信キュー（生成されたメール内容）
- **マスターデータ**: 都道府県、市区町村、職種、雇用形態、給与タイプ、特徴など

---

## 実装上の考慮事項

### データ処理
- CSVインポートは1000件単位のバッチ処理で実装
- Pandas DataFrameを使用した効率的なデータ変換
- Supabase Python クライアントでの一括挿入

### スコアリング
- 基礎スコア: 時給、アクセス、福利厚生、人気度の4要素
- SEOスコア: semrush_keywordsテーブルとのマッチング
- パーソナライズスコア: 協調フィルタリングアルゴリズム

### マッチング
- 各ユーザー40件の内訳:
  - TOP5: 最高スコア5件
  - 地域別TOP10: 居住都道府県の求人10件
  - 近隣TOP10: 居住市区町村と隣接市の求人10件
  - お得バイトTOP10: 特典付き求人10件
  - 新着5件: 3日以内の求人5件

### SQLモニタリング
- Next.js App Routerで実装
- Supabase接続でリアルタイムクエリ実行
- テーブル一覧、データプレビュー、統計情報表示

---

## レビュー＆承認チェックリスト
*ゲート: main()実行中に自動チェックが実行されます*

### コンテンツ品質
- [x] 実装の詳細なし（言語、フレームワーク、API）
- [x] ユーザー価値とビジネスニーズに焦点を当てる
- [x] 非技術的な関係者向けに書かれている
- [x] すべての必須セクションが完了

### 要件の完全性
- [x] [要確認]マーカーが残っていない
- [x] 要件はテスト可能で明確
- [x] 成功基準は測定可能
- [x] スコープが明確に境界付けられている
- [x] 依存関係と仮定が識別されている

---

## 実行ステータス
*処理中にmain()によって更新*

- [x] ユーザーの説明を解析
- [x] 主要概念を抽出
- [x] あいまいさをマーク
- [x] ユーザーシナリオを定義
- [x] 要件を生成
- [x] エンティティを識別
- [x] レビューチェックリストに合格

---

## 次のステップ
1. この仕様書のレビューと承認
2. `/plan` コマンドで実装計画を策定
3. `/tasks` コマンドでタスク分解
4. 実装開始（Supabaseセットアップから）